# Equivariant Diffusion Policy 论文综合笔记

## 1. 研究主题

### 研究领域和背景
- **行为克隆的挑战** (Behavior Cloning Challenges)
  - 多模态动作分布学习困难
  - 需要大量示范数据
  - 泛化性能有限

- **扩散模型的应用** (Diffusion Models in Robotics)
  - 有效捕获多模态分布
  - 去噪函数学习复杂
  - 数据效率待提高

- **等变性的价值** (Value of Equivariance)
  - 嵌入任务对称性
  - 提供归纳偏置
  - 增强泛化能力

### 关键技术术语
- **扩散策略** (Diffusion Policy): 基于DDPM的行为克隆方法
  > **原理**：通过迭代去噪过程生成动作
  $$
  \mathbf{a}^{k-1} = \alpha(\mathbf{a}^k - \gamma\varepsilon_\theta(\mathbf{o}, \mathbf{a}^k, k) + \epsilon)
  $$
  > **挑战**：去噪函数比标准策略函数更复杂

- **等变性** (Equivariance): 函数与群变换的交换性质
  > **定义**：对于变换g和函数f，满足：
  $$
  f(g \cdot x) = g \cdot f(x), \forall g \in G
  $$
  > **意义**：保持几何变换的一致性

- **SO(2)群**: 二维特殊正交群，描述平面旋转
  > 三种主要表示方法：
  > 1. 平凡表示 (trivial representation): $\rho_0(g)x = x$
  > 2. 不可约表示 (irreducible representation): $\rho_{\omega}(g)v = R(\omega g)v$
  > 3. 正则表示 (regular representation): $\rho_{reg}(g)x = Px$

### 研究问题与动机
1. 如何提高扩散模型在策略学习中的数据效率
  > **现状**：扩散模型需要大量数据训练去噪函数
  > **挑战**：示范数据采集成本高

2. 如何在扩散过程中利用任务的几何对称性
  > **观察**：机器人任务通常具有旋转对称性
  > **机会**：将对称性作为归纳偏置

3. 如何将等变性应用于6自由度机器人控制
  > **难点**：SE(3)空间的等变性表示复杂
  > **创新**：设计特殊的等变表示方法

### 现有方法分析

#### 1. 扩散模型在机器人领域的应用
- **优势**：
  - 有效建模多模态分布
  - 生成高质量轨迹
  - 支持条件生成
- **局限**：
  - 计算开销大
  - 数据需求高
  - 训练不稳定

#### 2. 等变性在机器人控制中的应用
- **已有工作**：
  - SE(2)闭环控制
  - SE(3)开环规划
  - 点云等变处理
- **不足**：
  - 未应用于扩散模型
  - 表示能力有限
  - 缺乏理论支撑

## 2. 技术创新

### 核心创新点
1. **等变扩散策略**
  > **设计思路**：
  - 在扩散过程中保持SO(2)等变性
  - 理论证明了噪声预测函数的等变性质
  - 设计了适应6自由度控制的等变表示
  > **技术优势**：
  - 减少学习参数量
  - 提高数据效率
  - 增强泛化能力

2. **SO(2)表示在6自由度动作空间的应用**
  > **关键设计**：
  - 将6自由度动作分解为不同的等变分量
  - 设计了适合不同分量的表示方法
  - 实现了完整的等变控制框架
  > **创新点**：
  - 首次在扩散策略中应用等变性
  - 扩展到完整SE(3)空间
  - 支持闭环控制

### 理论基础
1. **等变性定理**
  > **命题1**：当专家策略π具有SO(2)等变性时，噪声预测函数ε也具有SO(2)等变性
  $$
  \pi(g\mathbf{o}) = g\pi(\mathbf{o})
  $$
  
  2. 对于任意噪声εᵏ，有：
  $$
  \varepsilon(\mathbf{o}, \pi(\mathbf{o}) + \varepsilon^k, k) = \varepsilon^k
  $$
  
  3. 对输入应用变换g：
  $$
  \begin{aligned}
  \varepsilon(g\mathbf{o}, g\pi(\mathbf{o}) + g\varepsilon^k, k) &= \\
  \varepsilon(g\mathbf{o}, \pi(g\mathbf{o}) + g\varepsilon^k, k) &= \text{// 利用π的等变性} \\
  g\varepsilon(\mathbf{o}, \pi(\mathbf{o}) + \varepsilon^k, k) &= \text{// 等变性要求} \\
  g\varepsilon^k &= \text{// 由步骤2}
  \end{aligned}
  $$

  > **推论1**：等变噪声预测函数能够保持扩散过程中的几何对称性
  $$
  \alpha^{k-1} = \alpha(\alpha^k - \gamma\varepsilon(\mathbf{o}, \alpha^k, k) + \mathcal{N}(0, \sigma^2I))
  $$
  
  2. 对输入应用变换g：
  $$
  \begin{aligned}
  g\cdot\alpha^{k-1} &= \alpha(g\cdot\alpha^k - \gamma g\cdot\varepsilon(\mathbf{o}, \alpha^k, k) + g\cdot\mathcal{N}(0, \sigma^2I)) \\
  &= \alpha(g\cdot\alpha^k - \gamma\varepsilon(g\cdot\mathbf{o}, g\cdot\alpha^k, k) + \mathcal{N}(0, \sigma^2I))
  \end{aligned}
  $$

2. **6自由度动作表示**
  > **命题2**：存在描述SO(2)作用于SE(3)抓取器动作的不可约表示
  1. 绝对位姿控制：
   设$\alpha_t = \text{Vec}_c(A_t)$，其中$A_t \in \text{SE}(3)$
   $$
   g\cdot\alpha_t = (\rho_1 \oplus \rho_0^2)^4(g)\alpha_t
   $$
   其中：
   - $\rho_1$是2D旋转表示
   - $\rho_0$是标量不变表示
   - ⊕表示直和
   - ⁴表示4次重复
  
  2. 相对位姿控制：
   设$\alpha_t = \text{Vec}_r(A_t)$
   $$
   g\cdot\alpha_t = P^{-1}[(\rho_0^6 \oplus \rho_1^4 \oplus \rho_2)(g)]P\cdot\alpha_t
   $$
   其中：
   - P是固定的变基矩阵
   - $\rho_2$是频率2的旋转表示

  > **推论2**：完整的动作表示可分解为三个部分
  1. 位置部分：
    - 使用$\rho_1$表示平面位置
    - 使用$\rho_0$表示高度
  
  2. 旋转部分：
    - 绝对控制：使用SO(3)的等变表示
    - 相对控制：使用特殊的矩阵分解
  
  3. 抓取器状态：
    - 使用$\rho_0$表示开合宽度
    - 保持旋转不变性

### 模型架构
### 整体架构设计
> **设计原则**：保持端到端的SO(2)等变性
```
输入 -> 等变编码器 -> 等变特征 -> 等变噪声预测网络 -> 等变输出
```

1. **等变编码器**
  > **输入处理**：
  - 3D体素输入
  - SO(2)等变卷积层
  - 特征聚合模块
  > **实现细节**：
  - 使用escnn库
  - 正则表示嵌入
  - 特征维度：u×d

  > **等变性保证**：
  - 体素网格使用圆柱坐标系
  - 卷积核权重共享遵循SO(2)群规则
  - 特征图保持等变表示

2. **等变噪声预测网络**
  > **网络结构**：
  - 多头注意力机制
  - 等变MLP层
  - 条件化生成模块
  > **训练策略**：
  - 时间步：100
  - 批量大小：128
  - 优化器：AdamW

  > **等变性实现**：
  - 注意力计算：
    $$Q = W_q f_{\text{in}}, K = W_k f_{\text{in}}, V = W_v f_{\text{in}}$$
    $$\text{Attention}(Q,K,V) = \text{softmax}(\frac{QK^T}{\sqrt{d_k}})V$$
  - 等变MLP：
    $$h_l = \phi(W_l^{\rho_{\text{out}}, \rho_{\text{in}}} h_{l-1})$$
    其中$W_l$满足等变约束

### 模型组件详解

#### 1. 等变体素编码器
```
输入: 3D体素网格 [B×C×H×W×D]
↓ 等变卷积层 (保持SO(2)等变性)
中间特征 [B×F×H'×W'×D']
↓ 等变池化 (保持等变性)
输出特征 [B×F'×H''×W''×D'']
```

#### 2. 等变注意力模块
```
输入: 等变特征 [B×N×D]
↓ 等变线性投影
Q,K,V 计算 (保持群作用)
↓ 注意力权重计算
输出: 等变特征 [B×N×D]
```

#### 3. 等变噪声预测器
```
输入: 状态特征 + 噪声动作
↓ 等变MLP (群等变线性层)
中间特征
↓ 等变解码器
输出: 预测噪声 (保持SO(2)等变性)
```

### 实现细节

#### 1. 等变卷积实现
- **权重参数化**：
  $$W(r,\theta) = \sum_{m=-M}^M w_m(r)e^{im\theta}$$
- **特征表示**：
  $$f_{\text{out}}(x) = \int W(r,\theta)f_{\text{in}}(R_{-\theta}x)d\theta$$

#### 2. 等变MLP实现
- **线性层**：
  $$W \in \text{Hom}_G(\rho_{\text{in}}, \rho_{\text{out}})$$
- **激活函数**：
  $$\phi: \rho_{\text{in}} \to \rho_{\text{out}}$$
  满足：$\phi(gx) = g\phi(x)$

#### 3. 损失函数设计
- **重建损失**：
  $$\mathcal{L}_{\text{recon}} = \|\varepsilon_\theta(\mathbf{o}, \alpha^k, k) - \varepsilon^k\|^2$$
- **等变性约束**：
  $$\mathcal{L}_{\text{equiv}} = \|\varepsilon_\theta(g\mathbf{o}, g\alpha^k, k) - g\varepsilon_\theta(\mathbf{o}, \alpha^k, k)\|^2$$

## 3. 实验结果

### 仿真实验
- **MimicGen基准测试**：
  > **任务设置**：
  - 12个操作任务
  - 平均成功率提升21.9%
  - 100个示范数据训练
  > **对比结果**：
  - 超过DiffPo-C 14.8%
  - 超过DiffPo-T 21.9%
  - 超过DP3 17.6%

### 真实机器人实验
- **任务设置**：
  > **硬件配置**：
  - 6个不同操作任务
  - 20-60个示范数据
  - 单相机观察
  > **环境设置**：
  - Franka Emika机械臂
  - Intel Realsense D455相机
  - 自定义夹持器

- **实验结果**：
  | 任务 | 示范数量 | 成功率 |
  |------|---------|--------|
  | 烤箱开门 | 20 | 95% |
  | 香蕉放碗 | 40 | 95% |
  | 信件对齐 | 40 | 95% |
  | 垃圾清扫 | 40 | 90% |
  | 锤子入抽 | 50 | 85% |
  | 面包烘焙 | 58 | 80% |

### 消融实验
- **等变性影响**：
  - 移除等变性：性能下降17.6%
  - 仅使用数据增强：性能下降10.3%

- **输入模态影响**：
  - 体素vs图像：体素提升4.1%
  - 视角不变性分析

## 4. 方法优势与局限

### 优势
1. **数据效率**
  - 显著减少所需示范数据
  - 提高学习效率
  - 加快收敛速度

2. **泛化能力**
  - 对旋转变换鲁棒
  - 适应不同初始状态
  - 支持跨任务迁移

### 局限性
1. **视觉系统的对称性破坏**
  - 机械臂出现在视野中
  - 相机噪声影响
  - 视角限制

2. **等变性假设的局限**
  - 并非所有任务都具有完美对称性
  - 某些示范可能违反等变性
  - 计算开销增加

## 5. 未来方向
### 技术改进
1. 设计无对称性破坏的视觉系统
2. 扩展到其他机器人任务领域
3. 研究其他类型的等变性
4. 结合其他策略学习方法

### 应用拓展
1. 多机器人协同控制
2. 复杂动态环境适应
3. 人机交互场景

## 补充说明
本研究通过在扩散策略中引入等变性，显著提高了机器人操作学习的效率和性能。其理论分析和实验验证为将等变性应用于复杂机器人控制提供了重要参考。

### 理论基础
#### SE(2)与平面外旋转的关系

> **SE(2)群**：特殊欧几里得群，描述平面上的刚体运动
```
1. 组成：
   - 平面平移 (x,y)
   - 平面内旋转 θ (绕z轴)

2. 矩阵表示：
   [cos θ  -sin θ  tx]
   [sin θ   cos θ  ty]
   [  0       0     1]
```

> **平面外旋转**：
```
1. 定义：
   - 绕x轴或y轴的旋转
   - 不属于SE(2)变换
   - 会改变物体的高度或倾斜角度

2. 示例：
   - 倾倒水杯
   - 开合盖子
   - 翻转物体
```

> **在机器人操作中的意义**：
```
1. SE(2)等变性：
   - 适用于平面上的移动和抓取
   - 保持物体的竖直姿态
   - 例如：在桌面上推动物体

2. 平面外旋转：
   - 需要额外的表示方法
   - 不能用SE(2)等变性处理
   - 例如：倾倒、翻转等操作
```

> **本文的处理方式**：
```
1. SE(2)部分：
   - 使用标准的等变表示
   - 直接应用群论结果

2. 平面外旋转：
   - 使用特殊的表示方法
   - 将旋转分解为多个分量
   - 分别处理不同的旋转自由度
``` 